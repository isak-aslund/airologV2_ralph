# Ralph Progress Log
Started: 2026-01-26

## Codebase Patterns
- Use Python virtual environment `.venv/` for backend dependencies
- Run typecheck with: `source .venv/bin/activate && mypy backend/ --ignore-missing-imports`
- Test FastAPI server with: `uvicorn backend.main:app --host 127.0.0.1 --port 8000`
- pydantic-settings required for BaseSettings with env vars support in Pydantic v2
- ULog parsing: use `pyulog.ULog(file_path)` - timestamps in microseconds, GPS as int*1e7, params via `.initial_parameters`
- Router pattern: create `backend/routers/{module}.py` with `APIRouter(prefix="/api/{resource}", tags=["{resource}"])`, register in main.py
- Tags are always stored lowercase; use `get_or_create_tags(db, tag_names)` helper for tag creation
- Frontend: Run npm commands from `frontend/` directory; typecheck with `npx tsc --noEmit`, build with `npm run build`
- Frontend: TailwindCSS v4 uses `@import "tailwindcss";` in CSS (not @tailwind directives)
- Test data files located in `test_data/` directory (5 .ulg files for upload testing)
- ULog timestamps: `start_timestamp` is boot-relative (not Unix epoch). Use `time_ref_utc` from `msg_info_dict` to get absolute time
- Flight date fallback: Parse from original filename if `time_ref_utc` is 0 (pattern: YYYY-MM-DD-HH-MM-SS)
- GPS sources in ULog (try in order): `vehicle_gps_position`, `sensor_gps`, `vehicle_local_position.ref_lat/ref_lon`

- UploadPage: `selectedFiles` is array of File objects, use `handleFilesSelect()` for adding files, `handleRemoveFile(index)` for removal
- UploadPage: "Defaults for all files" section with pilot/drone model is shown above file list when files are selected
- UploadPage: Per-file overrides stored in `fileOverrides` Map (keyed by filename), expansion state in `expandedFiles` Set
- UploadPage: Per-file metadata stored in `fileMetadataStates` Map (keyed by filename) with `FileMetadataState` interface (isLoading, error, metadata)
- Metadata extraction: useEffect triggers parallel extraction via Promise.all when new files added; only extracts for files not already in state
- UploadPage: Batch upload state uses `isBatchUploading`, `batchUploadIndex`, `batchUploadComplete`, and `fileUploadStatuses` Map (keyed by filename) with `FileUploadStatus` interface
- UploadPage: `handleBatchUpload()` uploads files sequentially, uses per-file overrides or defaults, continues on individual failures
- UploadPage: After batch completes, `batchUploadComplete` triggers summary UI with success count/failed count, retry buttons, and clear completed button
- UploadPage: `handleRetryFile(file)` retries a single failed file, `handleClearCompleted()` removes all successful files from list

---

## 2026-01-26 - US-048
- What was implemented: Batch upload completion handling with retry for failed files and clear completed functionality
- Files changed:
  - `frontend/src/pages/UploadPage.tsx` - Added `batchUploadComplete` state, `getBatchUploadSummary()` helper, `isAllFilesSucceeded()` helper, `handleRetryFile()` for individual file retry, `handleClearCompleted()` to remove successful uploads, completion summary UI with success/failure counts, "Go to Flight Logs" button when all succeed
- **Learnings for future iterations:**
  - Batch completion tracked with `batchUploadComplete` boolean - set to true at end of `handleBatchUpload()`
  - Summary UI shows in green box when all succeed, amber box when some failed
  - "Clear Completed" button only appears when at least one file succeeded
  - "Add More Files" button hidden after batch completes to encourage user to address failures or navigate away
  - `handleClearCompleted()` filters out successful files and cleans up all related state Maps (overrides, expanded, metadata, upload status)
  - Retry button appears inline with error message for each failed file
---

## 2026-01-26 - US-047
- What was implemented: Batch upload submission with sequential uploads and per-file status tracking
- Files changed:
  - `frontend/src/pages/UploadPage.tsx` - Added `FileUploadStatus` interface, `isBatchUploading`/`batchUploadIndex`/`fileUploadStatuses` state, `isBatchUploadValid` validation, `handleBatchUpload()` for sequential uploads with per-file override support, per-file upload status icons (spinner/check/X) and labels, progress indicator in button ("Uploading X of Y"), state cleanup in remove functions
- **Learnings for future iterations:**
  - Batch upload uses sequential uploads (for loop with await) rather than parallel to avoid overwhelming the server
  - Per-file status is tracked independently - a failure in one file doesn't stop the batch
  - The button shows "Upload All (N files)" when idle and "Uploading X of Y..." during upload
  - Per-file overrides are applied at upload time: title, pilot, drone_model, comment, tags fall back to defaults if not set
  - Upload statuses are stored in `fileUploadStatuses` Map with status enum: pending, uploading, success, error
---

## 2026-01-26 - US-046
- What was implemented: Per-file metadata preview with parallel extraction
- Files changed:
  - `frontend/src/pages/UploadPage.tsx` - Added `FileMetadataState` interface, `fileMetadataStates` Map state, parallel metadata extraction via Promise.all in useEffect, inline metadata display in file list (duration, date, serial, GPS), loading spinner per file, error state per file
- **Learnings for future iterations:**
  - Metadata extraction uses deduplication check (`!fileMetadataStates.get(file.name)`) to avoid re-extracting for already-processed files
  - Per-file states are cleaned up in `handleRemoveFile` and `handleRemoveAllFiles`
  - Legacy single-file state (`metadata`, `isExtracting`, `extractionError`) is still updated for backward compatibility with single-file upload flow
  - Error state uses amber warning color to indicate file is still uploadable despite extraction failure
  - useEffect dependency includes `fileMetadataStates` to properly trigger when state changes
---

## 2026-01-26 - US-045
- What was implemented: Per-file override capability with expandable/collapsible sections
- Files changed:
  - `frontend/src/pages/UploadPage.tsx` - Added `FileOverride` interface, `fileOverrides` Map state, `expandedFiles` Set state, helper functions (`getFileOverride`, `updateFileOverride`, `toggleFileExpanded`, `isFileExpanded`, `getTitleFromFilename`), updated file list to render expandable override sections with chevron toggle
- **Learnings for future iterations:**
  - Override data stored in Map keyed by filename - allows preserving overrides even when file order changes
  - Title is pre-populated from filename (without .ulg) using `getTitleFromFilename()` helper
  - Override fields show "Use default if empty" or similar placeholder to indicate defaults apply
  - State cleanup happens in `handleRemoveFile` and `handleRemoveAllFiles` to avoid stale override data
  - TagInput component reused for per-file tags with custom placeholder
---

## 2026-01-26 - US-044
- What was implemented: Common defaults form section for batch upload
- Files changed:
  - `frontend/src/pages/UploadPage.tsx` - Added "Defaults for all files" section with pilot input (autocomplete) and drone model dropdown above the file selection area; removed duplicate fields from lower Flight Details section
- **Learnings for future iterations:**
  - Common fields (pilot, drone_model) now appear above file list when files are selected
  - Per-file fields (title, comment, tags) remain in the Flight Details section below metadata (for single file mode or future per-file overrides)
  - Form validation (`isFormValid`) still checks all required fields including defaults
---

## 2026-01-26 - US-043
- What was implemented: Multi-file selection in upload form
- Files changed:
  - `frontend/src/pages/UploadPage.tsx` - Changed from single file to array of files, added `multiple` attribute to input, created scrollable file list with remove buttons
- **Learnings for future iterations:**
  - Files selected via input are added to existing selection (not replaced) - allows incremental file picking
  - Duplicates prevented by filename matching via `existingNames` Set
  - Reset file input value after selection to allow re-selecting same files
  - Metadata extraction still only works for single-file mode (will be enhanced in US-046)
---

## 2026-01-26 - US-042
- What was implemented: Fixed flight_date extraction bug in ULog parser
- Files changed:
  - `backend/services/ulog_parser.py` - Added `_parse_date_from_filename()` helper, updated `extract_metadata()` to use `time_ref_utc` or filename fallback, improved GPS extraction to try multiple sources
  - `backend/routers/logs.py` - Pass original filename to `extract_metadata()`
- **Learnings for future iterations:**
  - ULog `start_timestamp` is NOT Unix epoch - it's microseconds since boot time
  - `time_ref_utc` in `msg_info_dict` provides the offset to convert to UTC
  - When uploading files, the mtime is lost (file is written fresh) - can't use mtime as fallback
  - Many test ULog files don't have GPS data (indoor tests) - this is expected, not a bug
---

